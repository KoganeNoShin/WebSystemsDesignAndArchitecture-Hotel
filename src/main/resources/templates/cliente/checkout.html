<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-out - Comitini Residence</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/cliente/checkout.css}">
</head>
<body>

    <header>
        <a href="/home" class="logo">Comitini Residence</a>
        <a th:href="@{/cliente/dashboard}" class="btn-login">Dashboard</a>
    </header>

    <div class="checkout-page">
        <div class="checkout-container">
            <h1>Check-out e Pagamento</h1>
            <p style="text-align: center; color: #ccc; margin-bottom: 2rem;">
                Riepilogo finale del soggiorno presso <span th:text="${prenotazione.camera.sede.nome}">Cortina</span>
            </p>

            <!-- Avviso Check-out Anticipato -->
            <div th:if="${isAnticipato}" class="alert-warning">
                <h3>⚠️ Partenza Anticipata</h3>
                <p>Stai effettuando il check-out prima della data prevista (<span th:text="${prenotazione.dataFine}">Data</span>).</p>
                <p>Hai diritto a uno <strong>sconto del 50%</strong> sulle <span th:text="${nottiRimanenti}">2</span> notti non usufruite.</p>
            </div>

            <!-- Riepilogo Costi -->
            <h3 class="section-title">Dettaglio Costi</h3>

            <div class="summary-item">
                <span>Camera (<span th:text="${nottiUsufruite}">3</span> notti usufruite):</span>
                <strong th:text="'€ ' + ${#numbers.formatDecimal(costoCameraFinale + sconto, 1, 2)}">€ 300.00</strong>
            </div>

            <div th:if="${isAnticipato}" class="summary-item" style="color: #ffcc00;">
                <span>Sconto Partenza Anticipata:</span>
                <strong th:text="'- € ' + ${#numbers.formatDecimal(sconto, 1, 2)}">- € 50.00</strong>
            </div>

            <div class="summary-item">
                <span>Servizi Extra:</span>
                <strong th:text="'€ ' + ${#numbers.formatDecimal(costoServizi, 1, 2)}">€ 50.00</strong>
            </div>

            <div class="summary-item">
                <span>Multimedia:</span>
                <strong th:text="'€ ' + ${#numbers.formatDecimal(costoMultimedia, 1, 2)}">€ 15.00</strong>
            </div>

            <div class="summary-item">
                <span>Tassa di Soggiorno:</span>
                <strong th:text="'€ ' + ${#numbers.formatDecimal(costoTassaSoggiorno, 1, 2)}">€ 10.00</strong>
            </div>

            <div th:if="${numEsenzioni > 0}" class="summary-item" style="font-size: 0.9rem; color: #aaa;">
                <span>(Esenzioni applicate per <span th:text="${numEsenzioni}">1</span> ospiti under 12)</span>
            </div>

            <div class="total-row">
                <span>Totale da Pagare:</span>
                <span th:text="'€ ' + ${#numbers.formatDecimal(totaleDaPagare, 1, 2)}">€ 315.00</span>
            </div>

            <!-- Form Pagamento -->
            <form th:action="@{/cliente/checkout/confirm}" method="post" class="payment-form" onsubmit="return validatePayment()">
                <input type="hidden" name="prenotazioneId" th:value="${prenotazione.id}">
                <input type="hidden" name="totalePagato" th:value="${totaleDaPagare}">

                <h3 class="section-title">Metodo di Pagamento</h3>
                <div class="form-group">
                    <label>Intestatario Carta</label>
                    <input type="text" id="cardName" class="form-control" placeholder="Mario Rossi" required minlength="5" maxlength="50">
                    <small id="nameError" style="color: #ff4d4d; display: none;">Nome troppo breve o non valido.</small>
                </div>
                <div class="form-group">
                    <label>Numero Carta</label>
                    <input type="text" class="form-control" placeholder="0000 0000 0000 0000" required pattern="\d{16}" title="Inserisci 16 cifre senza spazi">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Scadenza</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="expiryMonth" class="form-control" required style="width: 80px;">
                                <option value="" disabled selected>MM</option>
                                <option th:each="i : ${#numbers.sequence(1, 12)}" th:value="${i}" th:text="${i < 10 ? '0' + i : i}"></option>
                            </select>
                            <select id="expiryYear" class="form-control" required style="width: 100px;">
                                <option value="" disabled selected>YYYY</option>
                                <option th:each="i : ${#numbers.sequence(0, 10)}" th:value="${#dates.year(#dates.createNow()) + i}" th:text="${#dates.year(#dates.createNow()) + i}"></option>
                            </select>
                        </div>
                        <small id="expiryError" style="color: #ff4d4d; display: none;">Carta scaduta.</small>
                    </div>
                    <div class="form-group">
                        <label>CVV</label>
                        <input type="text" class="form-control" placeholder="123" required pattern="\d{3}" title="3 cifre">
                    </div>
                </div>

                <button type="submit" class="btn-pay">Paga e Concludi Soggiorno</button>
            </form>
        </div>
    </div>

    <footer>
        <nav>
            <ul class="nav-links">
                <li><a th:href="@{/home/rooms}">Le Nostre Camere</a></li>
                <li><a th:href="@{/home/services}">Servizi</a></li>
                <li><a th:href="@{/home/contact}">Contatti</a></li>
            </ul>
        </nav>
    </footer>

    <script>
        function validatePayment() {
            let isValid = true;

            // Validazione Nome
            const nameInput = document.getElementById('cardName');
            const nameError = document.getElementById('nameError');
            if (nameInput.value.trim().length < 5 || !/^[a-zA-Z\s]+$/.test(nameInput.value)) {
                nameError.style.display = 'block';
                nameInput.style.borderColor = '#ff4d4d';
                isValid = false;
            } else {
                nameError.style.display = 'none';
                nameInput.style.borderColor = '#555';
            }

            // Validazione Scadenza
            const monthSelect = document.getElementById('expiryMonth');
            const yearSelect = document.getElementById('expiryYear');
            const expiryError = document.getElementById('expiryError');

            const expMonth = parseInt(monthSelect.value, 10);
            const expYear = parseInt(yearSelect.value, 10);

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            if (!expMonth || !expYear) {
                isValid = false; // Campi non selezionati
            } else if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                expiryError.style.display = 'block';
                monthSelect.style.borderColor = '#ff4d4d';
                yearSelect.style.borderColor = '#ff4d4d';
                isValid = false;
            } else {
                expiryError.style.display = 'none';
                monthSelect.style.borderColor = '#555';
                yearSelect.style.borderColor = '#555';
            }

            return isValid;
        }
    </script>

</body>
</html>
